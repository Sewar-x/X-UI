# XHTTP

xhttp æ¨¡å—æ˜¯åŸºäº [axios](https://www.axios-http.cn/docs/intro) äºŒæ¬¡å°è£…ï¼Œåœ¨ axios çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›é€‚é…åå°ç®¡ç†ç³»ç»Ÿçš„åŠŸèƒ½ã€‚

## åŠŸèƒ½

> axios åŠŸèƒ½å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[èµ·æ­¥ | Axiosä¸­æ–‡æ–‡æ¡£ | Axiosä¸­æ–‡ç½‘ (axios-http.cn)](https://www.axios-http.cn/docs/intro)

xhttp é™¤äº†æ”¯æŒ axios çš„åŸºç¡€åŠŸèƒ½ä¹‹å¤–ï¼Œå°è£…äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

| åŠŸèƒ½                           | ä»‹ç»                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| æ¶ˆæ¯æç¤º                       | æˆåŠŸ/å¤±è´¥/é”™è¯¯ç­‰æ¶ˆæ¯å’Œæ¨¡æ€å¼¹çª—æç¤º åœ¨æµè§ˆå™¨ç«¯ä½¿ç”¨æ¶ˆæ¯å’Œæ¨¡æ€å¼¹çª—æç¤º åœ¨node ç«¯ä½¿ç”¨ console æ‰“å° |
| å¿½ç•¥é‡å¤è¯·æ±‚                   |                                                              |
| è¶…æ—¶é‡è¯•                       |                                                              |
| åŠ å…¥è¯·æ±‚æ—¶é—´æˆ³                 | è¯·æ±‚æ—¶é—´æˆ³å¯ä»¥ç”¨äºè°ƒè¯•æ¥å£                                   |
| ä¸Šä¼ æ–‡ä»¶é»˜è®¤é‡‡ç”¨ formdata æ ¼å¼ | ä¸Šä¼ æ–‡ä»¶é»˜è®¤é…ç½®ï¼š  `header:{Content-type: FORM_DATA = 'multipart/form-data;charset=UTF-8',}` |
| å›ºå®šçŠ¶æ€ç æç¤ºå’Œå¤„ç†           |                                                              |
| ajax é”™è¯¯æ—¥å¿—æ”¶é›†é’©å­          | `addAjaxErrorInfo`                                           |
| å…¨å±€è¯·æ±‚ token                 |                                                              |
| **token æ ¡éªŒ**                 |                                                              |
| **token åˆ·æ–°**                 |                                                              |
| é”™è¯¯æ¸…é™¤ token                 |                                                              |
| é”™è¯¯é€€å‡ºç™»å½•                   |                                                              |
| æ ¼å¼åŒ–è¿”å›æ ¼å¼                 | æ ¼å¼åŒ–è¿”å›æ ¼å¼                                               |
| æä¾›è¯·æ±‚å¤„ç†é’©å­               |                                                              |
|                                | è¯·æ±‚ä¹‹å‰å¤„ç†é…ç½®: `beforeRequestHook`                        |
|                                | è¯·æ±‚æˆåŠŸå¤„ç†: `transformRequestData`                         |
|                                | è¯·æ±‚å¤±è´¥å¤„ç†: `requestCatch`                                 |
|                                | è¯·æ±‚ä¹‹å‰çš„æ‹¦æˆªå™¨: `requestInterceptors`                      |
|                                | è¯·æ±‚ä¹‹åçš„æ‹¦æˆªå™¨: `responseInterceptors`                     |
|                                | è¯·æ±‚ä¹‹å‰çš„æ‹¦æˆªå™¨é”™è¯¯å¤„ç†: `requestInterceptorsCatch`         |
|                                | è¯·æ±‚ä¹‹åçš„æ‹¦æˆªå™¨é”™è¯¯å¤„ç†: `responseInterceptorsCatch`        |

é»˜è®¤çŠ¶æ€ç æ£€æŸ¥ï¼š

| çŠ¶æ€ç  | æç¤ºæ–‡æ¡ˆ                                | æ“ä½œ |
| ------ | --------------------------------------- | ---- |
| 400    | é»˜è®¤é”™è¯¯ï¼Œè¿”å›æœåŠ¡ç«¯è¿”å›æ¶ˆæ¯æç¤º        |      |
| 401    | ç”¨æˆ·æ²¡æœ‰æƒé™ï¼ˆä»¤ç‰Œã€ç”¨æˆ·åã€å¯†ç é”™è¯¯ï¼‰! |      |
| 403    | ç”¨æˆ·å¾—åˆ°æˆæƒï¼Œä½†æ˜¯è®¿é—®æ˜¯è¢«ç¦æ­¢çš„!       |      |
| 404    | ç½‘ç»œè¯·æ±‚é”™è¯¯,æœªæ‰¾åˆ°è¯¥èµ„æº!              |      |
| 405    | ç½‘ç»œè¯·æ±‚é”™è¯¯,è¯·æ±‚æ–¹æ³•æœªå…è®¸!            |      |
| 408    | ç½‘ç»œè¯·æ±‚è¶…æ—¶!                           |      |
| 500    | æœåŠ¡å™¨é”™è¯¯,è¯·è”ç³»ç®¡ç†å‘˜!                |      |
| 501    | ç½‘ç»œæœªå®ç°!                             |      |
| 502    | ç½‘ç»œé”™è¯¯!                               |      |
| 503    | æœåŠ¡ä¸å¯ç”¨ï¼ŒæœåŠ¡å™¨æš‚æ—¶è¿‡è½½æˆ–ç»´æŠ¤!       |      |
| 504    | ç½‘ç»œè¶…æ—¶!                               |      |
| 505    | httpç‰ˆæœ¬ä¸æ”¯æŒè¯¥è¯·æ±‚!                   |      |





## å®‰è£…

å¯ä»¥å¼•å…¥ xw-ui åº“

```shell
npm install xw-ui
```

ä¹Ÿå¯ä»¥ç›´æ¥å•ç‹¬ä½¿ç”¨ xhttp åº“

```shell
npm install xhttp
```





## ä½¿ç”¨

### TypeScript

å¼•å…¥ xhttp åº“:

```typescript
import { createXhttp } from 'xw-ui/xhttp'

export default createXhttp({
    tokenKey: 'test-token', // token keyå€¼ï¼Œä¼ å…¥token keyå€¼ï¼Œé»˜è®¤ä½¿ç”¨å†…éƒ¨è·å–æ–¹æ³•
    tokenExpires: 1, // token è¿‡æœŸæ—¶é—´
    storageType: 'cookie', // å­˜å‚¨token æ–¹æ³•
    addAjaxErrorInfo: (error) => {
        console.log("ğŸš€ ==========é”™è¯¯æ—¥å¿—æ”¶é›†æ–¹æ³•===========", error)
    },
    getToken: () => {
        console.log('==============è·å–æœ¬åœ°token æ–¹æ³•============')
        return '1234567890'
    },
    logout: () => {
        console.log('==============logout é€€å‡ºç™»å½•æ–¹æ³•============')
    },
    statusMap: {
        400: {
            msg: '400çŠ¶æ€ç ',
            callback: () => {
                console.log('=============400çŠ¶æ€ç ç›¸å…³å¤„ç†å‡½æ•°===============')
            },
        },
        401: {
            msg: '401çŠ¶æ€ç ',
            callback: () => {
                console.log('=============401çŠ¶æ€ç ç›¸å…³å¤„ç†å‡½æ•°===============')
            },
        },
        402: {
            msg: '402çŠ¶æ€ç ',
            callback: () => {
                console.log('=============402çŠ¶æ€ç ç›¸å…³å¤„ç†å‡½æ•°===============')
            },
        },
        404: {
            msg: '404çŠ¶æ€ç ',
            callback: () => {
                console.log('=============404çŠ¶æ€ç ç›¸å…³å¤„ç†å‡½æ•°===============')
            },
        },
        500: {
            msg: '500çŠ¶æ€ç ',
            callback: () => {
                console.log('=============404çŠ¶æ€ç ç›¸å…³å¤„ç†å‡½æ•°===============')
            },
        }
    }
},
    {
        requestOptions: {
            urlPrefix: 'api'
        }
    });

```

ä½¿ç”¨ xhttp åº“ï¼š

```	typescript
import defHttp from '@/packages/http/index'

interface AccountInfoModel {
    email: string;
    name: string;
    introduction: string;
    phone: string;
    address: string;
}

export function setAccountInfo(params: AccountInfoModel) {
    return defHttp.post<AccountInfoModel>(
        {
            url: '/acount/post',
            params,
        },
        {
            errorMessageMode: 'modal',
        },
    );
}

export function getAccountInfo(params: AccountInfoModel) {
    return defHttp.get(
        {
            url: '/acount/get',
            params
        },
        {
            successMessageMode: 'message',
            errorMessageMode: 'message',
        },
    );
}

```

### è¯·æ±‚å‚æ•°

| æ–¹æ³•                  | å‚æ•°                        | å‚æ•°å¯é€‰å€¼                           | è¯´æ˜           |
| --------------------- | --------------------------- | ------------------------------------ | -------------- |
| `get(options,msgOpt)` | options                     |                                      | axios è¯·æ±‚å‚æ•° |
|                       | msgOpt                      | errorMessageModeã€successMessageMode | æ¶ˆæ¯ç±»å‹å‚æ•°   |
|                       | `msgOpt.errorMessageMode`   | modalã€messageã€none                 | é”™è¯¯æ¶ˆæ¯æç¤º   |
|                       | `msgOpt.successMessageMode` | modalã€messageã€none                 | æˆåŠŸæ¶ˆæ¯æç¤º   |

### å“åº”æ•°æ®

é»˜è®¤æœåŠ¡ç«¯è¿”å›é»˜è®¤ä¸ºä»¥ä¸‹æ•°æ®æ ¼å¼ï¼š

```json
{
    'code': 0, // 0 è¡¨ç¤ºæˆåŠŸï¼Œ-1 è¡¨ç¤ºå¤±è´¥
    'message': 'è¿”å›æ¶ˆæ¯',
    'result': {} // å“åº”ç»“æ„
    }
}
```

å¦‚æœæœåŠ¡ç«¯è¿”å›æ¥å£æ— æ³•è¿”å›ä»¥ä¸Šå›ºå®šæ ¼å¼ï¼Œåˆ™éœ€è¦åœ¨ `createXhttp` ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ `formatResponse` æ–¹æ³•ï¼Œå¯¹è¿”å›çš„æ•°æ®æ ¼å¼è¿›è¡Œæ ¼å¼åŒ–ã€‚

å¦‚æœåŠ¡ç«¯è¿”å›å¦‚ä¸‹æ ¼å¼ï¼š

```js
{
    "Code": 200, // çŠ¶æ€ç 
    "Msg": "OK", // æç¤ºä¿¡æ¯
    "Data": {} // æ•°æ®
}
```

åˆ™åœ¨åˆ›å»º http å®ä¾‹æ—¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```js
import { createXhttp } from 'xw-ui/xhttp'

export default createXhttp({
    tokenKey: 'test-token', // token keyå€¼ï¼Œä¼ å…¥token keyå€¼ï¼Œé»˜è®¤ä½¿ç”¨å†…éƒ¨è·å–æ–¹æ³•
    tokenExpires: 1, // token è¿‡æœŸæ—¶é—´
    formatResponse: (data)=> {//å‚æ•° formatResponse æ–¹æ³•ï¼Œå¯¹è¿”å›çš„æ•°æ®æ ¼å¼è¿›è¡Œæ ¼å¼åŒ–ã€‚
        return { // å°†æœåŠ¡ç«¯è¿”å›çš„æ•°æ®æ ¼å¼åŒ–
            code: data.Code,
            message: data.Msg,
            result: data.Data
        }
    } , // å­˜å‚¨token æ–¹æ³•
},
{
    requestOptions: {
        urlPrefix: 'api'
    }
});
```



## é»˜è®¤é…ç½®å‚æ•°

`createXhttp(transformOpt: transformOptType, axiosOpt: Partial<CreateAxiosOptions>) ` æ–¹æ³•å‚æ•°

### transformOpt å‚æ•°

| å‚æ•°                       | åŠŸèƒ½                      | ç±»å‹                                           | é»˜è®¤å€¼         |
| -------------------------- | ------------------------- | ---------------------------------------------- | -------------- |
| `Message`ï¼ˆå¯é€‰ï¼‰          | æ¶ˆæ¯æç¤ºç»„ä»¶              | `Fcuntion`                                     |                |
| `Modal`ï¼ˆå¯é€‰ï¼‰            | æ¨¡æ€å¼¹çª—æç¤ºç»„ä»¶          | `Fcuntion`                                     |                |
| `tokenKey`ï¼ˆå¯é€‰ï¼‰         | ç™»å½• token Key å€¼         | `string`                                       | `Bearer`       |
| `tokenExpires`ï¼ˆå¯é€‰ï¼‰     | ç™»å½• token è¿‡æœŸæ—¶é—´       | `number`                                       | 7 å¤©           |
| `storageType`ï¼ˆå¯é€‰ï¼‰      | token å­˜å‚¨ç±»å‹            | `localStorage` æˆ– `sessionStorage` æˆ– `cookie` | `localStorage` |
| `getToken`ï¼ˆå¯é€‰ï¼‰         | è·å– token æ–¹æ³•           | `Function`                                     |                |
| `setToken`ï¼ˆå¯é€‰ï¼‰         | è®¾ç½® token æ–¹æ³•           | `Function`                                     |                |
| `logout`ï¼ˆå¯é€‰ï¼‰           | é€€å‡ºç™»å½•æ–¹æ³•              | `Function`                                     |                |
| `addAjaxErrorInfo`ï¼ˆå¯é€‰ï¼‰ | æ·»åŠ  ajax é”™è¯¯æ—¥å¿—æ–¹æ³•    | `Function`                                     |                |
| `statusMap`ï¼ˆå¯é€‰ï¼‰        | çŠ¶æ€ç å’Œå¤„ç†æ–¹æ³• map å¯¹è±¡ | ` Record<number, any>`                         |                |



### axiosOpt å‚æ•°

| å‚æ•°                                      | åŠŸèƒ½                                                | ç±»å‹ | é»˜è®¤å€¼                                                       |
| ----------------------------------------- | --------------------------------------------------- | ---- | ------------------------------------------------------------ |
| axios é…ç½®                                |                                                     |      |                                                              |
| `authenticationScheme`                    | HTTP éªŒè¯                                           |      | authentication schemesï¼Œe.g: Bearer <br />authenticationScheme: 'Bearer', |
| `timeout`                                 | æ¥å£è¶…æ—¶ç­‰å¾…æ—¶é—´                                    |      | 10 * 1000                                                    |
| `headers`                                 | http å¤´å‚æ•°                                         |      | `{ 'Content-Type': ContentTypeEnum.JSON }`<br />   å¦‚æœæ˜¯form-dataæ ¼å¼ï¼š <br />`{ 'Content-Type': ContentTypeEnum.FORM_URLENCODED }` |
| `transform`                               | æ•°æ®å¤„ç†æ–¹å¼                                        |      |                                                              |
| `requestOptions`                          | è¯·æ±‚é€‰é¡¹                                            |      |                                                              |
| `requestOptions.joinPrefix`               | æ˜¯å¦å°† prefix æ·»åŠ åˆ°url                             |      | `true`                                                       |
| `requestOptions.isReturnNativeResponse`   | æ˜¯å¦è¿”å›åŸç”Ÿå“åº”å¤´ æ¯”å¦‚ï¼šéœ€è¦è·å–å“åº”å¤´æ—¶ä½¿ç”¨è¯¥å±æ€§ |      | `false`                                                      |
| `requestOptions.isTransformResponse`      | éœ€è¦å¯¹è¿”å›æ•°æ®è¿›è¡Œå¤„ç†                              |      | `true`                                                       |
| `requestOptions.joinParamsToUrl`          | postè¯·æ±‚çš„æ—¶å€™æ·»åŠ å‚æ•°åˆ° url                        |      | `false`                                                      |
| `requestOptions.formatDate`               | æ ¼å¼åŒ–æäº¤å‚æ•°æ—¶é—´                                  |      | `true`                                                       |
| `requestOptions.errorMessageMode`         | æ¶ˆæ¯æç¤ºç»„ä»¶                                        |      | `message`(å¯é€‰å‚æ•°ï¼š<br />`none æˆ– modal æˆ–message`)         |
| `requestOptions.apiUrl`                   | æ¥å£åœ°å€                                            |      | `''`                                                         |
| `requestOptions.urlPrefix`                | æ¥å£æ‹¼æ¥åœ°å€                                        |      | `''`                                                         |
| `requestOptions.joinTime`                 | æ˜¯å¦åŠ å…¥æ—¶é—´æˆ³                                      |      | `true`                                                       |
| `requestOptions.ignoreCancelToken`        | å¿½ç•¥é‡å¤è¯·æ±‚                                        |      | `true`                                                       |
| `requestOptions.withToken`                | æ˜¯å¦æºå¸¦token                                       |      | `true`                                                       |
| `requestOptions.retryRequest`             | è¯·æ±‚é‡è¯•é…ç½®                                        |      |                                                              |
| `requestOptions.retryRequest.isOpenRetry` | æ˜¯å¦å¼€å¯è¯·æ±‚é‡è¯•                                    |      | `true`                                                       |
| `requestOptions.retryRequest.count`       | è¯·æ±‚é‡è¯•æ¬¡æ•°                                        |      | `5`                                                          |
| `requestOptions.retryRequest.waitTime`    | è¯·æ±‚é‡è¯•ç­‰å¾…æ—¶é—´                                    |      | `100`                                                        |

